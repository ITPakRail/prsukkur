<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pakistan Rail - Live Multi-Train Tracker</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .dashboard { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .controls { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; background: #e3f2fd; padding: 15px; border-radius: 8px; flex-wrap: wrap; }
        select { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; min-width: 250px; }
        .btn-capture { background: #1a237e; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-capture:hover { background: #0d47a1; }
        .status-badge { padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .live { background: #c8e6c9; color: #2e7d32; }
        .waiting { background: #fff9c4; color: #827717; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; }
        th { background: #1a237e; color: white; }
        tr:hover { background-color: #f9f9f9; }
        .station-name { color: #d32f2f; font-weight: bold; }
    </style>
</head>
<body>

<div class="dashboard">
    <h2>Pakistan Railways Live Tracker</h2>
    
    <div class="controls">
        <label for="trainSelect"><strong>Select Live Train:</strong></label>
        <select id="trainSelect" onchange="handleTrainChange()">
            <option value="">Loading live trains...</option>
        </select>
        <span id="liveStatus" class="status-badge waiting">Connecting...</span>
        <button class="btn-capture" onclick="takeSnapshot()">CAPTURE SNAPSHOT</button>
    </div>

    <div id="trainDescription" style="margin-bottom:10px; color:#666; font-style: italic;"></div>

    <table>
        <thead>
            <tr>
                <th>Code</th>
                <th>Lat/Lon</th>
                <th>Speed</th>
                <th>Prev Station</th>
                <th>Next Station</th>
                <th>Delay</th>
                <th>Captured At</th>
            </tr>
        </thead>
        <tbody id="snapshot-body">
            <tr><td colspan="7" style="text-align:center; color:#999;">Select a train and wait for GPS pulse...</td></tr>
        </tbody>
    </table>
</div>

<script>
    let socket;
    let liveBuffer = null;
    let currentStations = [];
    let selectedTrainId = ""; // e.g. "27"

    // 1. Initial Load: Get all trains for dropdown
    async function loadAllTrains() {
        try {
            const res = await fetch('https://app-api.pakraillive.com/api/Train/GetLiveTrains');
            const data = await res.json();
            const select = document.getElementById('trainSelect');
            select.innerHTML = '<option value="">-- Choose a Train --</option>';

            if (data.IsSuccess) {
                // Filter only live trains and populate dropdown
                data.Response.filter(t => t.IsLive).forEach(train => {
                    const opt = document.createElement('option');
                    opt.value = train.TrainId;
                    opt.textContent = `${train.TrainNameWithNumber} (${train.TrainDescription})`;
                    select.appendChild(opt);
                });
                document.getElementById('liveStatus').innerText = "Select a train";
            }
        } catch (e) {
            console.error("Error loading trains", e);
        }
    }

    // 2. When user selects a train from dropdown
    // Replace your existing handleTrainChange with this improved version
async function handleTrainChange() {
        const select = document.getElementById('trainSelect');
        selectedTrainId = select.value;
        liveBuffer = null; // Reset buffer for new train
        
        if (!selectedTrainId) return;

        document.getElementById('liveStatus').className = "status-badge waiting";
        document.getElementById('liveStatus').innerText = "Fetching Stations...";
        
        // Fetch Stations for the newly selected train
        try {
            const res = await fetch(`https://app-api.pakraillive.com/api/Train/GetTrainStationsByTrainId?id=${selectedTrainId}`);
            const data = await res.json();
            currentStations = data.IsSuccess ? data.Response : [];
            document.getElementById('liveStatus').innerText = "Waiting for GPS pulse...";
        } catch (e) {
            console.error("Error loading stations", e);
        }
    }    // 3. Setup WebSocket (Shared for all selections)
    function initWebSocket() {
        socket = io("wss://cotrolroomapi.pakraillive.com", {
            transports: ["websocket"],
            path: "/socket.io/"
        });

        socket.onAny((trainCode, data) => {
            // Check if the incoming trainCode starts with our selected ID
            // e.g., if selectedTrainId is "27", matches "271201"
            if (selectedTrainId && trainCode.startsWith(selectedTrainId)) {
                liveBuffer = { code: trainCode, ...data };
                const status = document.getElementById('liveStatus');
                status.className = "status-badge live";
                status.innerText = `LIVE: Receiving ${trainCode}`;
            }
        });
    }

    // Helper to find station name from our cached list
    function getStationName(id) {
        if (!id) return "N/A";
        const found = currentStations.find(s => s.StationDetailsId.toString() === id.toString());
        return found ? found.StationName : `ID: ${id}`;
    }

    // 4. Capture Button Logic
    function takeSnapshot() {
        if (!liveBuffer) {
            alert("No live data received yet for this train.");
            return;
        }

        const tbody = document.getElementById('snapshot-body');
        if (tbody.innerHTML.includes("Select a train")) tbody.innerHTML = "";

        const prev = getStationName(liveBuffer.prev_st);
        const next = getStationName(liveBuffer.next_st);
        
        const row = `
            <tr>
                <td><strong>${liveBuffer.code}</strong></td>
                <td>${liveBuffer.lat.toFixed(5)}, ${liveBuffer.lon.toFixed(5)}</td>
                <td>${liveBuffer.sp} km/h</td>
                <td class="station-name">${prev}</td>
                <td class="station-name">${next}</td>
                <td><span style="color:red">${liveBuffer.late_by}m</span></td>
                <td>${new Date().toLocaleTimeString()}</td>
            </tr>
        `;
        tbody.insertAdjacentHTML('afterbegin', row);
    }

    // Start
    loadAllTrains();
    initWebSocket();
</script>

</body>
</html>
