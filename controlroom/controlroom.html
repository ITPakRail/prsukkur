<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PR Sukkur - Executive Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root { --pr-green: #1b5e20; --pr-grass: #4db34d; --pr-maroon: #800000; }
        html { zoom: 90%; }
        body { background-color: var(--pr-grass); color: black; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding-bottom: 60px; }
        .nav-container { background: var(--pr-green); padding: 10px; display: flex; justify-content: center; gap: 15px; border-bottom: 4px solid #ffd700; position: sticky; top: 0; z-index: 2000; }
        .nav-btn { background: #fff; border: 2px solid var(--pr-maroon); padding: 8px 25px; font-size: 16px; cursor: pointer; border-radius: 6px; font-weight: bold; }
        .nav-btn.active { background: var(--pr-maroon); color: white; }
        .filter-bar { background: rgba(255,255,255,0.9); padding: 12px; border-bottom: 2px solid var(--pr-maroon); display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center; }
        .page-content { display: none; padding: 15px; }
        .page-content.active { display: block; }
        .card-panel { background: #f8f9fa; border: 2px solid var(--pr-maroon); border-radius: 8px; padding: 15px; height: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .section-title { background: var(--pr-green); color: white; padding: 6px; border-radius: 4px; margin-bottom: 12px; text-align: center; font-weight: bold; font-size: 17px; }
        .logo-img { height: 75px; width: 75px; object-fit: contain; background: white; border: 1px solid var(--pr-maroon); padding: 3px; border-radius: 5px; }
        .f-box { padding: 12px; text-align: center; border-radius: 8px; flex: 1; border: 2px solid #333; color: white; text-shadow: 1px 1px 2px black; }
        .f-label { font-size: 12px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.3); }
        .f-value { font-size: 24px; font-weight: 800; }
        .footer-credit { position: fixed; bottom: 0; width: 100%; background: white; padding: 8px; text-align: center; font-size: 14px; border-top: 3px solid var(--pr-maroon); z-index: 2000; }
        .chart-container { position: relative; height: 220px; width: 100%; flex-grow: 1; }
    </style>
</head>
<body>

<div class="nav-container">
    <button id="btn-summary" class="nav-btn active" onclick="showPage('summary-page', 'btn-summary')">EXECUTIVE SUMMARY</button>
    <button id="btn-freight" class="nav-btn" onclick="showPage('freight-page', 'btn-freight')">FREIGHT DETAIL</button>
</div>

<div id="summary-page" class="page-content active">
    <div class="filter-bar mb-3 rounded">
       <span class="fw-bold">RANGE:</span>
    <input type="date" id="startDate"> 
    <input type="date" id="endDate">
    <button class="btn btn-primary btn-sm fw-bold" onclick="fetchAndProcessData()">UPDATE DATA</button>
        <select><option>Train Type</option></select>
        <select><option>Direction</option></select>
        <select><option>Train No</option></select>
    </div>

    <div class="container-fluid">
        <div class="row align-items-center mb-3">
            <div class="col-2 text-start"><img src="https://upload.wikimedia.org/wikipedia/en/thumb/5/50/Pakistan_Railways_logo.svg/512px-Pakistan_Railways_logo.svg.png" class="logo-img"></div>
            <div class="col-8 text-center"><h2 class="fw-bold m-0" style="color: white; text-shadow: 2px 2px 4px #000;">EXECUTIVE OPERATIONAL SUMMARY OF SUKKUR DIVISION</h2></div>
            <div class="col-2 text-end"><img src="https://cdn-icons-png.flaticon.com/512/725/725287.png" class="logo-img"></div>
        </div>

        <div class="row g-3">
            <div class="col-md-4"><div class="card-panel"><div class="section-title">FREIGHT TRAINS RECEIVE & HANDOVER</div><div class="chart-container"><canvas id="handoverChart"></canvas></div></div></div>
            <div class="col-md-4"><div class="card-panel text-center"><div class="section-title">PASSENGER DETENTION HOURS BY HEAD</div><div class="chart-container"><canvas id="freightDonut"></canvas></div></div></div>
            <div class="col-md-4"><div class="card-panel"><div class="section-title">TOP 5 DELAY FREIGHT TRAINS</div><div class="chart-container"><canvas id="topFreightChart"></canvas></div></div></div>
        </div>

        <div class="row g-3 mt-1">
            <div class="col-md-6"><div class="card-panel"><div class="section-title">PASSENGER DELAY FACTORS</div><div class="chart-container"><canvas id="passFactorChart"></canvas></div></div></div>
            <div class="col-md-6">
                <div class="card-panel">
                    <div class="section-title">PASSENGER OUT TRAINS & PERCENTAGE</div>
                    <div class="d-flex gap-2 mb-3">
                        <div class="f-box" style="background:#2e7d32"><div class="f-label">Total Trains</div><div id="val-total" class="f-value">0</div></div>
                        <div class="f-box" style="background:#1565c0"><div class="f-label">Out Trains</div><div id="val-out" class="f-value">0</div></div>
                        <div class="f-box" style="background:#f9a825"><div class="f-label">Percentage</div><div id="val-perc" class="f-value">0%</div></div>
                    </div>
                    <div class="progress" style="height: 40px; border: 2px solid #333;">
                        <div id="prog-bar" class="progress-bar bg-success" style="width: 0%; font-size: 18px; font-weight: bold;">0% Accuracy</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="footer-credit">Prepared under the kind guidance of: <b>Mr. Jamshed Alam</b>, D.S. Sukkur.</div>

<div class="filter-bar mb-3 rounded">
    <span class="fw-bold">RANGE:</span>
    <input type="date" id="startDate"> 
    <input type="date" id="endDate">
    <button class="btn btn-primary btn-sm fw-bold" onclick="fetchAndProcessData()">UPDATE DATA</button>
</div>

<script>
    const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwo5osrV3JCoK55EGuOjjpzGneiarMPx8GClrbkdnV4zl6OytI7T2DHypD8T1TBI2medQ/exec"; 
    let cachedData = [];

    window.onload = function() {
        // Set Default Dates to Today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = today;
        document.getElementById('endDate').value = today;

        initStaticCharts();
        fetchAndProcessData();
    }

    // Custom parser for "15-Nov-25" format
    function parseSheetDate(dateStr) {
        if (!dateStr) return new Date(0);
        const months = {
            'Jan':0, 'Feb':1, 'Mar':2, 'Apr':3, 'May':4, 'Jun':5,
            'Jul':6, 'Aug':7, 'Sep':8, 'Oct':9, 'Nov':10, 'Dec':11
        };
        const parts = dateStr.split('-');
        if (parts.length !== 3) return new Date(dateStr); // Fallback
        
        const day = parseInt(parts[0]);
        const month = months[parts[1]];
        let year = parseInt(parts[2]);
        if (year < 100) year += 2000; // Handle '25' as 2025
        
        return new Date(year, month, day);
    }

    async function fetchAndProcessData() {
        const totalEl = document.getElementById('val-total');
        totalEl.innerText = "Loading...";

        try {
            // Using a simple fetch with no extra headers to avoid pre-flight CORS issues
            const response = await fetch(SHEET_API_URL);
            if (!response.ok) throw new Error('Network response was not ok');
            
            cachedData = await response.json();
            calculateMetrics();
        } catch (e) {
            console.error("Fetch Error:", e);
            totalEl.innerText = "ERR";
            alert("Connection Failed. Check if Deployment is set to 'Anyone'.");
        }
    }

    function calculateMetrics() {
        const startInput = document.getElementById('startDate').value;
        const endInput = document.getElementById('endDate').value;
        
        const start = new Date(startInput);
        const end = new Date(endInput);
        start.setHours(0,0,0,0);
        end.setHours(23,59,59,999);

        let sumTotal = 0;
        let sumOut = 0;

        cachedData.forEach(row => {
            // Use the custom parser for sheet dates
            const rowDate = parseSheetDate(row.DATE);
            
            if (rowDate >= start && rowDate <= end) {
                sumTotal += parseInt(row.TOTAL_TRAIN) || 0;
                sumOut += parseInt(row.TOTAL_OUT_TRAIN) || 0;
            }
        });

        const percentage = sumTotal > 0 ? ((sumOut / sumTotal) * 100).toFixed(2) : 0;
        
        document.getElementById('val-total').innerText = sumTotal;
        document.getElementById('val-out').innerText = sumOut;
        document.getElementById('val-perc').innerText = percentage + "%";
        
        const pb = document.getElementById('prog-bar');
        pb.style.width = percentage + "%";
        pb.innerText = percentage + "% Accuracy";
    }

    // ... (keep the rest of your showPage and initStaticCharts functions)
</script>
</body>
</html>
